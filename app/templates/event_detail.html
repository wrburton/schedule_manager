{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ rp(request) }}/events/upcoming" class="themed-accent hover:opacity-80">&larr; Back to upcoming</a>
</div>

<div class="themed-card rounded-lg p-6 neon-border{% if event.start_time.date() == today %} pulse-glow{% endif %}" data-event-id="{{ event.id }}">
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-2xl font-bold themed-text neon-text">{{ event.title }}</h1>
            <p class="themed-text-secondary mt-1">
                {{ event.start_time.strftime('%A, %B %d, %Y') }}
            </p>
            <p class="themed-text-secondary">
                {{ event.start_time.strftime('%I:%M %p') }} - {{ event.end_time.strftime('%I:%M %p') }}
            </p>
            {% if event.recurring_event_id %}
            <span class="inline-block mt-2 text-xs themed-text-muted px-2 py-1 rounded themed-border">
                Recurring event
            </span>
            {% endif %}
        </div>
        <div class="flex flex-col items-end space-y-2">
            {% if event.confirmations %}
            <span class="themed-badge-success px-3 py-1 rounded-full text-sm font-medium">
                Confirmed {{ event.confirmations[0].confirmed_at.strftime('%b %d at %I:%M %p') }}
            </span>
            {% endif %}
            {% if event.is_archived %}
            <span class="themed-text-muted px-3 py-1 rounded-full text-sm themed-border">
                Archived
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Description -->
    {% if event.description %}
    <div class="mb-6">
        <h2 class="text-sm font-medium themed-text-secondary mb-2">Description</h2>
        <div class="rounded p-3 themed-text-secondary text-sm whitespace-pre-wrap" style="background-color: var(--bg-secondary);">{{ event.description }}</div>
    </div>
    {% endif %}

    <!-- Attendees -->
    {% if event.attendees %}
    <div class="mb-6">
        <h2 class="text-sm font-medium themed-text-secondary mb-2">Attendees ({{ event.attendees | length }})</h2>
        <div class="space-y-2">
        {% for attendee in event.attendees %}
            <div class="flex items-center justify-between rounded p-2" style="background-color: var(--bg-secondary);">
                <div>
                    <span class="themed-text">{{ attendee.display_name or attendee.email }}</span>
                    {% if attendee.display_name %}
                    <span class="themed-text-muted text-sm ml-2">{{ attendee.email }}</span>
                    {% endif %}
                </div>
                <span class="text-xs px-2 py-1 rounded
                    {% if attendee.response_status == 'accepted' %}themed-badge-success
                    {% elif attendee.response_status == 'declined' %}themed-danger
                    {% elif attendee.response_status == 'tentative' %}themed-badge-warning
                    {% else %}themed-text-muted{% endif %}">
                    {{ attendee.response_status }}
                </span>
            </div>
        {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Checklist -->
    <div class="mb-6">
        <h2 class="text-sm font-medium themed-text-secondary mb-2">
            Checklist
            {% if event.items %}
            <span class="themed-text-muted font-normal" data-item-counter>
                ({{ event.items | selectattr('is_checked') | list | length }}/{{ event.items | length }} complete)
            </span>
            {% endif %}
            {% if has_unpushed and not event.is_archived %}
            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium themed-badge-warning">
                Unpushed changes
            </span>
            {% endif %}
        </h2>

        {% if event.is_archived %}
        <!-- Read-only checklist for archived events -->
        <div class="space-y-2">
        {% for item in event.items %}
            <div class="flex items-center p-2 rounded" style="background-color: var(--bg-secondary);">
                <span class="w-5 h-5 border rounded mr-3 flex items-center justify-center themed-checkbox
                    {% if item.is_checked %}checked{% endif %}">
                    {% if item.is_checked %}
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    {% endif %}
                </span>
                <span class="{% if item.is_checked %}opacity-50{% endif %} themed-text">
                    {{ item.name }}
                </span>
            </div>
        {% endfor %}
        </div>
        {% else %}
        <!-- Editable checklist -->
        <div class="space-y-2">
        {% for item in event.items %}
            <div class="flex items-center justify-between group" data-item-id="{{ item.id }}">
                <form action="{{ rp(request) }}/events/{{ event.id }}/items/{{ item.id }}/toggle" method="post" class="flex items-center flex-1">
                    <button type="submit" class="flex items-center w-full text-left p-2 rounded hover:opacity-80" data-toggle-item>
                        <span data-checkbox class="w-5 h-5 border rounded mr-3 flex items-center justify-center flex-shrink-0 themed-checkbox
                            {% if item.is_checked %}checked{% endif %}">
                            {% if item.is_checked %}
                            <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {% endif %}
                        </span>
                        <span data-item-text class="{% if item.is_checked %}line-through opacity-50{% endif %} themed-text">
                            {{ item.name }}
                        </span>
                    </button>
                </form>
                <div class="opacity-0 group-hover:opacity-100 flex items-center">
                    <form action="{{ rp(request) }}/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                        <button type="submit" class="themed-danger hover:opacity-80 text-sm px-2">
                            Delete
                        </button>
                    </form>
                    {% if event.recurring_event_id %}
                    <form action="{{ rp(request) }}/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                        <input type="hidden" name="delete_from_all" value="true">
                        <button type="submit" class="themed-danger opacity-70 hover:opacity-100 text-xs px-1 border-l themed-border">
                            All
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
        </div>

        <!-- Add item form -->
        <form action="{{ rp(request) }}/events/{{ event.id }}/items" method="post" class="mt-4">
            <div class="flex">
                <input type="text" name="name" placeholder="Add item..."
                       class="flex-1 border rounded-l px-3 py-2 themed-input focus:outline-none"
                       required>
                <button type="submit" class="themed-btn-primary px-4 py-2 rounded-r">
                    Add
                </button>
            </div>
            {% if event.recurring_event_id %}
            <label class="flex items-center mt-2 text-sm themed-text-muted cursor-pointer">
                <input type="checkbox" name="add_to_all" value="true" class="mr-2 rounded themed-border">
                Add to all future instances
            </label>
            {% endif %}
        </form>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-3 pt-6 border-t themed-border">
        {% if not event.is_archived %}
            {% if not event.confirmations %}
            <form action="{{ rp(request) }}/events/{{ event.id }}/confirm" method="post">
                <button type="submit"
                        class="themed-btn-success px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                        data-confirm-btn
                        {% if event.items and (event.items | rejectattr('is_checked') | list | length) > 0 %}disabled title="Complete all items first"{% endif %}>
                    Confirm Ready
                </button>
            </form>
            {% endif %}
            <form action="{{ rp(request) }}/events/{{ event.id }}/archive" method="post">
                <button type="submit" class="border themed-border themed-text-secondary px-4 py-2 rounded hover:opacity-80">
                    Archive
                </button>
            </form>
            <form action="{{ rp(request) }}/events/{{ event.id }}/items/push" method="post">
                <button type="submit" class="border themed-border themed-accent px-4 py-2 rounded hover:opacity-80 relative">
                    Push to Calendar
                    {% if has_unpushed %}
                    <span class="absolute -top-1 -right-1 h-3 w-3 rounded-full pulse-glow" style="background-color: var(--accent-warning);"></span>
                    {% endif %}
                </button>
            </form>
        {% else %}
            <form action="{{ rp(request) }}/events/{{ event.id }}/unarchive" method="post">
                <button type="submit" class="border themed-border themed-text-secondary px-4 py-2 rounded hover:opacity-80">
                    Unarchive
                </button>
            </form>
        {% endif %}
    </div>
</div>

<!-- Metadata -->
<div class="mt-4 text-sm themed-text-muted">
    <p>Last synced: {{ event.last_synced.strftime('%b %d, %Y at %I:%M %p') }}</p>
    <p>Google Event ID: {{ event.google_event_id }}</p>
</div>
{% endblock %}
