{% extends "base.html" %}

{% block title %}Upcoming Events{% endblock %}

{% block content %}
{% if not sync_status.success %}
<div class="themed-card rounded-lg p-4 mb-6 border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20">
    <div class="flex items-start">
        <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div class="flex-1">
            <h3 class="font-semibold text-yellow-800 dark:text-yellow-200">Calendar Sync Failed</h3>
            <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                {% if sync_status.error and 'credentials' in sync_status.error.lower() %}
                Authentication failed. Please <a href="/auth/setup" class="underline font-medium hover:opacity-80">reconfigure your credentials</a>.
                {% else %}
                Unable to sync with Google Calendar. The sync will retry automatically.
                {% endif %}
            </p>
            {% if sync_status.last_sync_time %}
            <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-2">
                Last attempt: {{ sync_status.last_sync_time.strftime('%b %d, %Y at %I:%M %p') }}
            </p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold themed-text">Upcoming Events</h1>
    {% if not has_auth %}
    <a href="/auth/setup" class="themed-btn-primary px-4 py-2 rounded hover:opacity-90">
        Setup Required
    </a>
    {% endif %}
</div>

{% if not today_events and not tomorrow_events and not later_events %}
<div class="themed-card rounded-lg p-6 text-center">
    {% if not has_auth %}
    <p class="themed-text-secondary mb-4">Google Calendar credentials need to be configured.</p>
    <a href="/auth/setup" class="themed-accent hover:opacity-80">View setup instructions</a>
    {% else %}
    <p class="themed-text-secondary">No upcoming events found.</p>
    <p class="themed-text-muted text-sm mt-2">Events will appear here after syncing from Google Calendar.</p>
    {% endif %}
</div>
{% endif %}

{#
    ============================================================
    TODAY'S EVENTS - Full Card Layout
    ============================================================
    Events happening today get the full treatment: large cards with
    all details visible (attendees, full checklist, action buttons).
    This is because today's events need immediate attention.
#}
{% if today_events %}
<div class="mb-8">
    <h2 class="text-lg font-semibold themed-text-secondary mb-4">Today</h2>
    <div class="space-y-6">
    {% for event in today_events %}
    <div class="themed-card rounded-lg p-6 neon-border{% if event.start_time.date() == today %} pulse-glow{% endif %}" data-event-id="{{ event.id }}">
        <div class="flex justify-between items-start mb-4">
            <div>
                <a href="/events/{{ event.id }}" class="text-xl font-semibold themed-text hover:themed-accent">
                    {{ event.title }}
                </a>
                <p class="themed-text-secondary">
                    {{ event.start_time.strftime('%a, %b %d, %Y') }} from {{ event.start_time.strftime('%I:%M %p') }} to {{ event.end_time.strftime('%I:%M %p') }}
                </p>
                {% if event.recurring_event_id %}
                <span class="text-xs themed-text-muted">Recurring event</span>
                {% endif %}
            </div>
            {% if event.confirmations %}
            <span class="themed-badge-success px-3 py-1 rounded-full text-sm font-medium">
                Confirmed
            </span>
            {% endif %}
        </div>

        <!-- Attendees -->
        {% if event.attendees %}
        <div class="mb-4">
            <h3 class="text-sm font-medium themed-text-secondary mb-2">Attendees</h3>
            <div class="flex flex-wrap gap-2">
            {% for attendee in event.attendees %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs themed-border
                    {% if attendee.response_status == 'accepted' %}themed-badge-success
                    {% elif attendee.response_status == 'declined' %}themed-danger
                    {% elif attendee.response_status == 'tentative' %}themed-badge-warning
                    {% else %}themed-text-muted{% endif %}">
                    {{ attendee.display_name or attendee.email.split('@')[0] }}
                </span>
            {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Checklist -->
        <div class="mb-4">
            <h3 class="text-sm font-medium themed-text-secondary mb-2">
                Checklist
                {% if event.items %}
                <span class="themed-text-muted font-normal" data-item-counter>
                    ({{ event.items | selectattr('is_checked') | list | length }}/{{ event.items | length }})
                </span>
                {% endif %}
                {% if unpushed_status[event.id|string] %}
                <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium themed-badge-warning">
                    Unpushed
                </span>
                {% endif %}
            </h3>

            {% if event.items %}
            <div class="space-y-2">
            {% for item in event.items %}
                <div class="flex items-center justify-between group" data-item-id="{{ item.id }}">
                    <form action="/events/{{ event.id }}/items/{{ item.id }}/toggle" method="post" class="flex items-center flex-1">
                        <button type="submit" class="flex items-center w-full text-left" data-toggle-item>
                            <span data-checkbox class="w-5 h-5 border rounded mr-3 flex items-center justify-center flex-shrink-0 themed-checkbox
                                {% if item.is_checked %}checked{% endif %}">
                                {% if item.is_checked %}
                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                {% endif %}
                            </span>
                            <span data-item-text class="{% if item.is_checked %}line-through opacity-50{% endif %} themed-text">
                                {{ item.name }}
                            </span>
                        </button>
                    </form>
                    <div class="opacity-0 group-hover:opacity-100 flex items-center">
                        <form action="/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                            <button type="submit" class="themed-danger hover:opacity-80 text-sm px-2">
                                Delete
                            </button>
                        </form>
                        {% if event.recurring_event_id %}
                        <form action="/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                            <input type="hidden" name="delete_from_all" value="true">
                            <button type="submit" class="themed-danger opacity-70 hover:opacity-100 text-xs px-1 border-l themed-border">
                                All
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
            {% else %}
            <p class="themed-text-muted text-sm">No items yet. Add items below or include them in your Google Calendar event description.</p>
            {% endif %}

            {# Add item form - allows users to add new checklist items #}
            <form action="/events/{{ event.id }}/items" method="post" class="mt-3">
                <div class="flex">
                    <input type="text" name="name" placeholder="Add item..."
                           class="flex-1 border rounded-l px-3 py-2 text-sm themed-input focus:outline-none"
                           required>
                    <button type="submit" class="themed-btn-primary px-4 py-2 rounded-r text-sm">
                        Add
                    </button>
                </div>
                {# RECURRING EVENT FEATURE: "Add to all future instances"
                   When checked, the new item is:
                   1. Added to this event instance (always)
                   2. Pushed to the MASTER recurring event in Google Calendar
                      (so future instances inherit it)
                   3. Added to all LOCAL instances within the sync window
                   This ensures the item appears everywhere, even for instances
                   beyond the current 30-day sync window. #}
                {% if event.recurring_event_id %}
                <label class="flex items-center mt-2 text-xs themed-text-muted cursor-pointer">
                    <input type="checkbox" name="add_to_all" value="true" class="mr-2 rounded themed-border">
                    Add to all future instances
                </label>
                {% endif %}
            </form>
        </div>

        <!-- Actions -->
        <div class="flex space-x-3 pt-4 border-t themed-border">
            {% if not event.confirmations %}
            <form action="/events/{{ event.id }}/confirm" method="post">
                <button type="submit"
                        class="themed-btn-success px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                        data-confirm-btn
                        {% if event.items and (event.items | rejectattr('is_checked') | list | length) > 0 %}disabled title="Complete all items first"{% endif %}>
                    Confirm Ready
                </button>
            </form>
            {% endif %}
            <form action="/events/{{ event.id }}/archive" method="post">
                <button type="submit" class="themed-text-secondary hover:themed-text px-4 py-2 border themed-border rounded hover:opacity-80">
                    Archive
                </button>
            </form>
            <a href="/events/{{ event.id }}" class="themed-accent hover:opacity-80 px-4 py-2">
                Details
            </a>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

{# Tomorrow's events use the same card layout as today's events #}
<!-- Tomorrow's Events - Large Cards -->
{% if tomorrow_events %}
<div class="mb-8">
    <h2 class="text-lg font-semibold themed-text-secondary mb-4">Tomorrow</h2>
    <div class="space-y-6">
    {% for event in tomorrow_events %}
    <div class="themed-card rounded-lg p-6 neon-border" data-event-id="{{ event.id }}">
        <div class="flex justify-between items-start mb-4">
            <div>
                <a href="/events/{{ event.id }}" class="text-xl font-semibold themed-text hover:themed-accent">
                    {{ event.title }}
                </a>
                <p class="themed-text-secondary">
                    {{ event.start_time.strftime('%a, %b %d, %Y') }} from {{ event.start_time.strftime('%I:%M %p') }} to {{ event.end_time.strftime('%I:%M %p') }}
                </p>
                {% if event.recurring_event_id %}
                <span class="text-xs themed-text-muted">Recurring event</span>
                {% endif %}
            </div>
            {% if event.confirmations %}
            <span class="themed-badge-success px-3 py-1 rounded-full text-sm font-medium">
                Confirmed
            </span>
            {% endif %}
        </div>

        <!-- Attendees -->
        {% if event.attendees %}
        <div class="mb-4">
            <h3 class="text-sm font-medium themed-text-secondary mb-2">Attendees</h3>
            <div class="flex flex-wrap gap-2">
            {% for attendee in event.attendees %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs themed-border
                    {% if attendee.response_status == 'accepted' %}themed-badge-success
                    {% elif attendee.response_status == 'declined' %}themed-danger
                    {% elif attendee.response_status == 'tentative' %}themed-badge-warning
                    {% else %}themed-text-muted{% endif %}">
                    {{ attendee.display_name or attendee.email.split('@')[0] }}
                </span>
            {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Checklist -->
        <div class="mb-4">
            <h3 class="text-sm font-medium themed-text-secondary mb-2">
                Checklist
                {% if event.items %}
                <span class="themed-text-muted font-normal" data-item-counter>
                    ({{ event.items | selectattr('is_checked') | list | length }}/{{ event.items | length }})
                </span>
                {% endif %}
                {% if unpushed_status[event.id|string] %}
                <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium themed-badge-warning">
                    Unpushed
                </span>
                {% endif %}
            </h3>

            {% if event.items %}
            <div class="space-y-2">
            {% for item in event.items %}
                <div class="flex items-center justify-between group" data-item-id="{{ item.id }}">
                    <form action="/events/{{ event.id }}/items/{{ item.id }}/toggle" method="post" class="flex items-center flex-1">
                        <button type="submit" class="flex items-center w-full text-left" data-toggle-item>
                            <span data-checkbox class="w-5 h-5 border rounded mr-3 flex items-center justify-center flex-shrink-0 themed-checkbox
                                {% if item.is_checked %}checked{% endif %}">
                                {% if item.is_checked %}
                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                {% endif %}
                            </span>
                            <span data-item-text class="{% if item.is_checked %}line-through opacity-50{% endif %} themed-text">
                                {{ item.name }}
                            </span>
                        </button>
                    </form>
                    <div class="opacity-0 group-hover:opacity-100 flex items-center">
                        <form action="/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                            <button type="submit" class="themed-danger hover:opacity-80 text-sm px-2">
                                Delete
                            </button>
                        </form>
                        {% if event.recurring_event_id %}
                        <form action="/events/{{ event.id }}/items/{{ item.id }}/delete" method="post">
                            <input type="hidden" name="delete_from_all" value="true">
                            <button type="submit" class="themed-danger opacity-70 hover:opacity-100 text-xs px-1 border-l themed-border">
                                All
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
            {% else %}
            <p class="themed-text-muted text-sm">No items yet. Add items below or include them in your Google Calendar event description.</p>
            {% endif %}

            <!-- Add item form -->
            <form action="/events/{{ event.id }}/items" method="post" class="mt-3">
                <div class="flex">
                    <input type="text" name="name" placeholder="Add item..."
                           class="flex-1 border rounded-l px-3 py-2 text-sm themed-input focus:outline-none"
                           required>
                    <button type="submit" class="themed-btn-primary px-4 py-2 rounded-r text-sm">
                        Add
                    </button>
                </div>
                {% if event.recurring_event_id %}
                <label class="flex items-center mt-2 text-xs themed-text-muted cursor-pointer">
                    <input type="checkbox" name="add_to_all" value="true" class="mr-2 rounded themed-border">
                    Add to all future instances
                </label>
                {% endif %}
            </form>
        </div>

        <!-- Actions -->
        <div class="flex space-x-3 pt-4 border-t themed-border">
            {% if not event.confirmations %}
            <form action="/events/{{ event.id }}/confirm" method="post">
                <button type="submit"
                        class="themed-btn-success px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                        data-confirm-btn
                        {% if event.items and (event.items | rejectattr('is_checked') | list | length) > 0 %}disabled title="Complete all items first"{% endif %}>
                    Confirm Ready
                </button>
            </form>
            {% endif %}
            <form action="/events/{{ event.id }}/archive" method="post">
                <button type="submit" class="themed-text-secondary hover:themed-text px-4 py-2 border themed-border rounded hover:opacity-80">
                    Archive
                </button>
            </form>
            <a href="/events/{{ event.id }}" class="themed-accent hover:opacity-80 px-4 py-2">
                Details
            </a>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

{#
    ============================================================
    COMING UP - Compact List with Date Grouping
    ============================================================
    Events 2+ days away are shown in a more compact format since
    they don't need immediate attention. They're grouped by date
    for easier scanning.

    JINJA2 NAMESPACE PATTERN:
    We need to track the previous date across loop iterations to
    detect when we should start a new date group. However, Jinja2
    variables set inside a loop are scoped to that iteration and
    don't persist.

    The solution is to use `namespace()` which creates an object
    whose attributes CAN be modified inside loops:

        {% set ns = namespace(prev_date=None) %}  <- Create namespace
        {% for event in events %}
            {% set ns.prev_date = current_date %}  <- Modify attribute
        {% endfor %}

    Without namespace, this would NOT work:
        {% set prev_date = None %}
        {% for event in events %}
            {% set prev_date = current_date %}  <- Creates NEW variable, doesn't modify outer
        {% endfor %}
#}
{% if later_events %}
<div>
    <h2 class="text-lg font-semibold themed-text-secondary mb-4">Coming Up</h2>
    <div class="space-y-3">
    {# Create a namespace to track the previous date across iterations #}
    {% set ns = namespace(prev_date=None) %}
    {% for event in later_events %}
        {% set current_date = event.start_time.date() %}
        {# When the date changes, close the previous card and open a new one #}
        {% if ns.prev_date != current_date %}
            {% if ns.prev_date is not none %}</div>{% endif %}
            <div class="themed-card rounded-lg divide-y themed-border">
        {% endif %}
        <a href="/events/{{ event.id }}" class="flex items-center justify-between p-4 hover:opacity-80 transition-colors">
            <div class="flex items-center space-x-4">
                <div class="text-center w-14">
                    <div class="text-xs themed-text-muted uppercase">{{ event.start_time.strftime('%b') }}</div>
                    <div class="text-xl font-bold themed-text">{{ event.start_time.strftime('%d') }}</div>
                </div>
                <div>
                    <div class="font-medium themed-text">{{ event.title }}</div>
                    <div class="text-sm themed-text-muted">{{ event.start_time.strftime('%a, %I:%M %p') }}</div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                {% if event.items %}
                <span class="text-xs themed-text-muted">
                    {{ event.items | selectattr('is_checked') | list | length }}/{{ event.items | length }} items
                </span>
                {% endif %}
                {% if event.confirmations %}
                <span class="themed-badge-success px-2 py-1 rounded text-xs">Confirmed</span>
                {% endif %}
                <svg class="w-5 h-5 themed-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </a>
        {# Update the tracked date for the next iteration #}
        {% set ns.prev_date = current_date %}
        {# Close the final date group card when we reach the last event #}
        {% if loop.last %}</div>{% endif %}
    {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
